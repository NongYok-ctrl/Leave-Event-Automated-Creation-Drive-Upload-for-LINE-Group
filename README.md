# ระบบสร้างกิจกรรมวันลาอัตโนมัติและอัปโหลดไฟล์สำหรับ LINE Group

ไฟล์นี้คือ n8n Workflow ที่ทำหน้าที่เป็น Webhook สำหรับ LINE Group หรือ Chatbot โดยเฉพาะ เพื่อดำเนินการ 2 ฟังก์ชันหลักคือ **1) บันทึกกิจกรรมวันลาลง Google Calendar อัตโนมัติ** และ **2) อัปโหลดไฟล์หรือรูปภาพไปยัง Google Drive อัตโนมัติ**

## วัตถุประสงค์และคุณสมบัติหลัก (Objectives & Features)

เวิร์กโฟลว์นี้ทำหน้าที่เป็นจุดรับข้อมูลจาก LINE และมีระบบการทำงานแบบแยกตามประเภทข้อมูล:

### 1. การจัดการการแจ้งวันลา (Leave Request Management)

* **ทริกเกอร์ตามข้อความ:** ระบบจะทำงานเมื่อข้อความที่ได้รับจาก LINE เป็นประเภท `text` และมีคำว่า 'ลา' อยู่ในข้อความ.
* **วิเคราะห์และสรุปการลา:** ใช้โค้ด JavaScript ในการดึงข้อมูลโปรไฟล์ผู้ใช้ (จาก LINE User ID) และวิเคราะห์ข้อความเพื่อระบุประเภทการลา (ลาป่วย, ลากิจ, ลาพักร้อน) เพื่อสร้างหัวข้อกิจกรรม (Event Summary).
* **สร้างกิจกรรมใน Google Calendar:** สร้างกิจกรรมตลอดทั้งวัน (All-day event) บน Google Calendar ที่กำหนดไว้ทันที โดยใช้หัวข้อและรายละเอียดที่ประมวลผลแล้ว.
* **ตอบกลับยืนยันด้วย AI:** ใช้ AI Agent สร้างข้อความยืนยันการบันทึกการลาอย่างสั้น สุภาพ และเป็นภาษาไทยกลับไปยังผู้ใช้ใน LINE ทันที.

### 2. การจัดการการอัปโหลดไฟล์ (File Upload Management)

* **ทริกเกอร์ตามไฟล์/รูปภาพ:** ระบบจะทำงานเมื่อข้อความที่ได้รับจาก LINE เป็นประเภท `image` หรือ `file`.
* **ดาวน์โหลดและอัปโหลด:** ดาวน์โหลดเนื้อหาไฟล์หรือรูปภาพจาก LINE Data API และอัปโหลดไปยังโฟลเดอร์ที่ระบุใน **Google Drive** โดยอัตโนมัติ.
* **แจ้งลิงก์ไฟล์:** ส่งข้อความตอบกลับใน LINE พร้อม **ลิงก์ (webViewLink)** ของไฟล์ที่อัปโหลดสำเร็จ เพื่อให้ผู้ใช้สามารถเข้าถึงได้ทันที.

## โครงสร้าง Workflow (Workflow Breakdown)

| Node (ชื่อ) | Type | วัตถุประสงค์ |
| :--- | :--- | :--- |
| Webhook | Webhook | ทริกเกอร์เมื่อได้รับข้อความ/ไฟล์จาก LINE. |
| ตรวจสอบว่าเป็นวันลาหรืออัพโหลดไฟล์ | If | แยกการทำงาน: (1) ข้อความแจ้งลา (มีคำว่า 'ลา') หรือ (2) รูปภาพ/ไฟล์. |
| Get User Profile | HTTP Request | ดึงชื่อผู้ใช้จาก LINE User ID เพื่อใช้ในการบันทึกกิจกรรม. |
| Code in JavaScript | Code | วิเคราะห์ข้อความเพื่อกำหนดประเภทการลาและสร้างหัวข้อกิจกรรม. |
| Create Google Calendar Event | Google Calendar | สร้างกิจกรรมใน Google Calendar (ปฏิทินวันลา) อัตโนมัติ. |
| AI Agent | AI Agent | สร้างข้อความยืนยันการบันทึกวันลาอย่างสั้นและสุภาพ. |
| ส่งผลการบันทึกกลับไปยัง Chat | HTTP Request | ส่งข้อความยืนยันการบันทึกวันลา (Reply Message) กลับไปยัง LINE. |
| ตรวจสอบว่าเป็นรูปหรือไฟล์ | If | แยกเส้นทางสำหรับข้อความที่เป็นประเภท `image` หรือ `file`. |
| Get file | HTTP Request | ดาวน์โหลดเนื้อหาไฟล์จาก LINE Data API. |
| Upload file | Google Drive | อัปโหลดไฟล์ที่ดาวน์โหลดไปยังโฟลเดอร์ที่กำหนดใน Google Drive. |
| ส่งผลการบันทึกกลับไปยังกลุ่มChat Line | HTTP Request | ส่งลิงก์ไฟล์ที่อัปโหลดสำเร็จ (Reply Message) กลับไปยัง LINE. |

## วิธีการใช้งาน (How to Use/Setup)

1.  **นำเข้าไฟล์:** นำเข้าไฟล์ `Leave Event Automated Creation + Drive Upload for LINE Group.json` ไปยัง n8n instance ของคุณ.
2.  **ตั้งค่า Credential:**
    * **HTTP Header Auth (LINE):** เชื่อมต่อ Credential สำหรับ LINE (เพื่อใช้ในการดึงโปรไฟล์, ดาวน์โหลดไฟล์, และตอบกลับ).
    * **Google Calendar OAuth2 API:** เชื่อมต่อ Credential สำหรับ Google Calendar.
    * **Google Gemini (PaLM) API:** เชื่อมต่อ Credential สำหรับ AI Agent.
    * **Google Drive OAuth2 API:** เชื่อมต่อ Credential สำหรับ Google Drive.
3.  **ตั้งค่าเฉพาะ (Custom Setup):**
    * **Create Google Calendar Event:** ตรวจสอบและเลือกปฏิทินวันลาที่ถูกต้อง (`Calendar` field).
    * **Upload file:** กำหนด `Folder ID` หรือ `Drive ID` ในโหนด **Upload file** ให้เป็นโฟลเดอร์ที่คุณต้องการจัดเก็บไฟล์ที่อัปโหลดจาก LINE.
    * **LINE Webhook:** ตั้งค่า Webhook URL ของโหนด **Webhook** นี้ในบัญชี LINE Official Account ของคุณ.
4.  **เปิดใช้งาน Workflow:** ตั้งค่า Workflow เป็น **Active** เพื่อให้ระบบทำงานโดยอัตโนมัติ.
